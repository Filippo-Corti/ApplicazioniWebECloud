<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PGRC | Search Results </title>
    <link rel="icon" href="../assets/img/favicon.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="../assets/css/my-colors.css">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body class="overflow-x-hidden min-vh-100 d-flex flex-column" onclick="hideSearchResults()" data-font="fancy">

    <!-- Background Stripes -->
    <div class="background-stripe">
    </div>

    <!-- Background Grid-->
    <div class="background-grid">
        <div class="d-none background-grid-col"></div>
        <div class="d-none background-grid-row"></div>
    </div>

    <!-- Header -->
    <header>
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg" aria-label="Offcanvas navbar large">
            <div class="container-xxl pt-4 pt-md-5 px-3">
                <!-- Logo -->
                <div>
                    <a class="logo | d-flex align-items-baseline gap-1" href="../index.html">
                        <img class="tint-primary" src="../assets/img/chef.png" alt="PGRC Logo">
                        <h1 class="h-0 text-primary">PGRC</h1>
                    </a>
                </div>
                <!-- Mobile Menu Button-->
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar"
                    aria-labelledby="offcanvasNavbarLabel">
                    <div class="offcanvas-header justify-content-end px-5 mt-3 pb-0">
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                    </div>
                    <div class="offcanvas-body justify-content-end">
                        <ul class="navbar-nav align-items-center gap-2">
                            <li class="nav-item logged-out-only">
                                <h5 class="text-center border-top border-bottom py-4 d-lg-none">
                                    SIGN UP for more functionalities!
                                </h5>
                            </li>
                            <li class="nav-item logged-out-only">
                                <a href="signup.html">
                                    <button class="btn btn-outline-secondary fs-4">
                                        SIGN UP
                                    </button>
                                </a>
                            </li>
                            <li class="nav-item logged-out-only">
                                <button class="btn btn-primary fs-4" data-bs-toggle="modal"
                                    data-bs-target="#loginModal">
                                    LOG IN
                                </button>
                            </li>
                            <li class="nav-item logged-in-only">
                                <a href="profile.html">
                                    <button class="btn btn-outline-secondary fs-4 d-flex align-items-center gap-2 py-2">
                                        <!-- Username & Picture -->
                                        <p class="username card-text bg-transparent mb-0">Username</p>
                                        <div class="profile-picture rounded-5 w-fit" >
                                            <img src="../assets/img/anon.png" alt="Profile Picture">
                                        </div>
                                    </button>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Search & Results-->
    <main class="container-xxl d-flex flex-column align-items-stretch my-3 px-3 px-md-5">


        <!-- Search Bar -->
        <div class="py-3 py-lg-5 my-2 py-lg-5 w-100">
            <form class="w-100" action="search.html">
                <div class="search-input position-relative bg-white rounded-5 border border-1 border-secondary fs-3">
                    <div class="d-flex flex-column flex-md-row w-100">
                        <input type="text" class="w-100 ps-4 rounded-5 border-0 form-control fs-3 my-1 my-lg-3"
                            name="search" id="search" placeholder='Try with "English Breakfast" ...'
                            onfocus="scrollToHere(this)" oninput="showSearchResults(this.value, '')" autocomplete="off">
                        <button class="btn btn-outline-secondary my-2 fs-4 mx-auto mx-md-2"
                            style="border-radius: 1.5rem;">Search</button>
                    </div>
                    <!-- Search Results-->
                    <div id="search_results"
                        class="search-results | w-100 bg-white position-absolute border-secondary border-start border-end border-bottom pb-4 rounded-bottom-5 d-none">
                        <!-- Search Result Cards -->
                    </div>
                </div>
            </form>
        </div>

        <!-- Results -->
        <div id="recipe-results" class="row p-lg-3 justify-content-center">

            <div class="container-xxl">
                <h2 class="keyword py-2">Sorry, 0 Results were found for current research</h2>
            </div>
            <!-- Recipe Result Cards -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="border-top border-black border-opacity-25">
        <div class="container-xxl d-flex flex-column flex-md-row py-5 mx-auto px-3 px-md-5 justify-content-between">
            <!-- Logo -->
            <div>
                <a class="logo | d-flex align-items-baseline gap-1" href="index.html">
                    <img class="tint-primary" src="../assets/img/chef.png" alt="PGRC Logo">
                    <h1 class="h-0 text-primary">PGRC</h1>
                </a>
            </div>
            <!-- Demo Buttons -->
            <div>
                <ul
                    class="list-group list-unstyled list-group-horizontal-md justify-content-center align-items-center d-flex gap-2 mt-2 mt-md-0">
                    <li>
                        <button
                            class="switch-font | btn btn-light border border-black border-2 fs-4 px-3 py-1 rounded-4"
                            onclick="switchFonts()" data-bs-toggle="tooltip" data-bs-placement="top"
                            data-bs-title="Switch Font">
                            Aa
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-outline-secondary fs-4" onclick="clearStorage(); location.reload();">
                            Reset Data
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-outline-secondary fs-4" onclick="loadDemoData();">
                            Load Demo Data
                        </button>
                    </li>
                </ul>
            </div>
        </div>
        </div>
    </footer>

    <!-- Modals -->

    <!-- Login Modal -->
    <modal class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="Modal For Login" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-3 rounded-5">
                <div class="modal-header border-0 row align-items-baseline">
                    <div class="line | col-3 bg-primary rounded-5 ms-1 d-none d-md-block"></div>
                    <h1 class="col-md-3 modal-title fs-4 text-center" id="exampleModalLabel">LOG IN</h1>
                    <div class="line | col bg-primary rounded-5 me-3 d-none d-md-block"></div>
                    <button type="button" class="col-1 btn-close mb-auto" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body py-1">
                    <div class="invalid-credentials | d-none text-center text-danger fs-6 mt-2">
                        <p>Credentials are wrong! Try again</p>
                    </div>
                    <form method="GET" action="search.html" onsubmit="return checkCredentialsAndLogin(this);">
                        <div class="col-12">
                            <div class="d-flex flex-column mt-2">
                                <label class="fs-5 text-dark" for="login_email">Email</label>
                                <input class="form-control rounded-2 p-2 border-2" type="email" name="email"
                                    id="login_email" autocomplete="username" required>
                            </div>
                            <div class="d-flex flex-column my-3 position-relative">
                                <label class="fs-5 text-dark" for="login_password">Password</label>
                                <img style="cursor: pointer;" class="position-absolute top-0 end-0"
                                    src="../assets/img/view.png" alt="Show Password" width="25"
                                    onclick="toggleShowPassword()">
                                <input class="toggle-visibility | form-control rounded-2 p-2 border-2" type="password"
                                    name="password" id="login_password" autocomplete="current-password" required>
                            </div>
                            <input class="keep-param" type="hidden" name="" value="">
                            <button type="submit" class="w-100 btn btn-primary fs-5 mt-4 mb-2">Log In</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer d-block border-0 text-center pt-0">
                    <p class="text-secondary mt-0 pt-0">Don't have an account? <a class="text-decoration-underline"
                            href="signup.html">Register
                            here</a></p>
                </div>
            </div>
        </div>
    </modal>

    <!-- Save Recipe Modal -->
    <modal class="modal fade" id="saveRecipeModal" tabindex="-1" aria-labelledby="Modal to Save Recipe"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-3 rounded-5">
                <div class="modal-header border-0 row align-items-baseline">
                    <div class="line | col-1 bg-primary col rounded-5 ms-1 d-none d-md-block"></div>
                    <h1 class="col-md-6 modal-title fs-4 text-center" id="exampleModalLabel">READY TO SAVE?</h1>
                    <div class="line | col bg-primary col rounded-5 me-3 d-none d-md-block"></div>
                    <button type="button" class="col-1 btn-close mb-auto" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body py-1">
                    <div class="invalid-credentials | d-none text-center text-danger fs-6 mt-2">
                        <p>Credentials are wrong! Try again</p>
                    </div>
                    <form method="GET" action="index.html" onsubmit="return saveRecipe(this)">
                        <div class="col-12">
                            <div class="card-text py-2 px-1 mb-1 position-relative">
                                <h5 class="text-black fs-6">Do you wanto to leave a note for <span
                                        class="modal-recipe-label | text-primary">Recipe Name</span>?</h5>
                                <textarea class="editable | w-100 rounded-5 border-2 ps-3 pe-5 py-2" id="note"
                                    name="note" rows="4"></textarea>
                                <input class="d-none" type="text" id="recipe_id" name="recipe_id">
                            </div>
                            <button type="submit" class="w-100 btn btn-primary fs-5 mt-3 mb-2" data-bs-dismiss="modal"
                                aria-label="Close">Save</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer d-block border-0 text-center pt-0">
                    <p class="text-secondary mt-0 pt-0">Saved recipes appear in your Cookbook!</p>
                </div>
            </div>
        </div>
    </modal>

    <!-- Templates -->

    <!-- Recipe Card -->
    <template id="recipe-card">
        <div class="recipe-card | rounded-5 overflow-hidden shadow-sm w-100 scale-on-hover"
            data-template-type="attribute" data-template-attribute="data-favourite" data-template-value="favourite"
            data-favourite="false">
            <a data-template-type="attribute" data-template-attribute="href" data-template-value="href"
                class="card border-0 position-relative h-100" href="recipe.html?id=00000">
                <img data-template-type="attribute" data-template-attribute="src" data-template-value="image"
                    src="https://www.themealdb.com/images/media/meals/kos9av1699014767.jpg"
                    class="recipe-image | card-img-top">
                <div class="card-body">
                    <div class="card-text row gap-2 justify-content-center mb-2">
                        <div class="col-3 d-flex align-items-center gap-2">
                            <img width="20" src="../assets/img/star.png" alt="Taste Score">
                            <span data-template-type="content" data-template-value="taste">0.0</span>
                        </div>
                        <div class="col-3 d-flex align-items-center gap-2">
                            <img class="tint-danger" width="20" src="../assets/img/chef.png" alt="Difficulty Score">
                            <span data-template-type="content" data-template-value="difficulty">0.0</span>
                        </div>
                        <div class="col-3 d-flex align-items-center gap-2">
                            <img width="20" src="../assets/img/comment.png" alt="Number of Reviews">
                            <span data-template-type="content" data-template-value="reviews">0</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h5 data-template-type="content" data-template-value="area"
                            class="card-title text-primary text-uppercase fs-5">Area Cuisine</h5>
                        <h4 data-template-type="content" data-template-value="name" class="card-title fs-3">Recipe Name
                        </h4>
                    </div>
                </div>
            </a>
            <div data-template-type="attribute" data-template-attribute="data-bs-recipe" data-template-value="name"
                class="recipe-save" data-bs-toggle="modal" data-bs-target="#saveRecipeModal"
                data-bs-recipe="Lamb Pilaf (Plov)">
                <div class="w-100 h-100" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Save Recipe">
                </div>
            </div>
        </div>
    </template>

    <!-- Recipe Card Group of 2-->
    <template id="recipe-card-group">
        <div class="flex-grow-1 recipe-card-group d-flex flex-column">
            <div data-template-type="element" data-template-value="row1"
                class="recipe-card-group-row d-flex gap-3 my-2">
                <!-- Recipe Card -->
                <!-- Recipe Card -->
            </div>
        </div>
    </template>

    <!-- Search Result Card -->
    <template id="search-result">
        <div data-template-type="attribute" data-template-attribute="data-type" data-template-value="type"
            class="search-result" data-type="recipe">
            <a data-template-type="attribute" data-template-attribute="href" data-template-value="href"
                class="ps-4 border-top py-3 d-flex gap-4 align-items-center" href="recipe.html?id=00000">
                <div class="search-result_image">
                    <img data-template-type="attribute" data-template-attribute="src" data-template-value="image"
                        class="" src="https://www.themealdb.com/images/media/meals/utxryw1511721587.jpg" width="76">
                </div>
                <div class="overflow-hidden">
                    <p data-template-type="content" data-template-value="name" class="search-result-title fs-4 mb-0">
                        Result Title</p>
                    <p data-template-type="content" data-template-value="description"
                        class="truncate-one-line fs-5 my-0 opacity-75 d-none d-md-block">Some more info about the result
                    </p>
                </div>
            </a>
        </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/storage.js"></script>
    <script src="../assets/js/form-control.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/test-data.js"></script>
    <script type="module">

        //Page Load
        let keyword = getURLParam("search");
        let category = getURLParam("category");
        let area = getURLParam("area");
        let ingredient = getURLParam("ingredient");
        let recipes_container = document.querySelector("#recipe-results");
        let results = await getSearchResults();
        if (results) {
            placeRecipesInGrid(results, recipes_container);
        }

        //Get results based on URL Params 
        async function getSearchResults() {
            let search_title = document.querySelector(".keyword");
            let keep_param_on_login = document.querySelector("input.keep-param"); //To keep the parameter in URL when page is reloaded after login form is submitted
            let found_recipes;

            if (keyword) {
                document.getElementById("search").value = keyword;
                found_recipes = await searchByName(keyword);
                if (found_recipes)
                    search_title.textContent = found_recipes.length + ' Results for the search "' + keyword + '"';
                keep_param_on_login.name = "search";
            } else if (category) {
                document.getElementById("search").value = category;
                found_recipes = await searchByCategory(category);
                if (found_recipes)
                    search_title.textContent = found_recipes.length + ' Results for the category "' + category + '"';
                keep_param_on_login.name = "category";
            } else if (area) {
                document.getElementById("search").value = area;
                found_recipes = await searchByArea(area);
                if (found_recipes)
                    search_title.textContent = found_recipes.length + ' Results for the area "' + area + '"';
                keep_param_on_login.name = "area";
            } else if (ingredient) {
                document.getElementById("search").value = ingredient;
                found_recipes = await searchByIngredient(ingredient);
                if (found_recipes)
                    search_title.textContent = found_recipes.length + ' Recipes with the ingredient "' + ingredient + '"';
                keep_param_on_login.name = "ingredient";
            }
            keep_param_on_login.value = document.getElementById("search").value;
            return found_recipes;
        }

        //Position recipes in container
        function placeRecipesInGrid(found_recipes, recipes_container) {
            for (let i = 0; i < found_recipes.length;) {
                let recipes = [];
                //Get 3 Recipes
                for (let j = 0; j < 2 && i < found_recipes.length; j++, i++) {
                    let recipe = found_recipes[i];
                    let recipe_stats = getRecipeReviewStats(recipe.idMeal);
                    recipes.push(
                        buildDynamicElement("recipe-card", {
                            href: "recipe.html?id=" + recipe.idMeal,
                            image: recipe.strMealThumb,
                            difficulty: recipe_stats.difficulty,
                            taste: recipe_stats.taste,
                            reviews: recipe_stats.reviews,
                            area: (recipe.strArea) ? recipe.strArea + " Cuisine" : " ",
                            name: recipe.strMeal,
                            favourite: isInCookbook(recipe.idMeal),
                        }));
                }
                //Place them in the page
                let dynamic_card_group = buildDynamicElement("recipe-card-group", {
                    row1: getElementHTML(recipes[0]) + getElementHTML(recipes[1]),
                });
                recipes_container.appendChild(dynamic_card_group);
            }
        }

    </script>
</body>

</html>