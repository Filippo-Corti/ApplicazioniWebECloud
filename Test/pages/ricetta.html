<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricettario Universitario</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../img/logo.png">
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Protest+Strike&display=swap" rel="stylesheet">
    <!-- Stili -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../stili.css">
</head>

<body>

    <!-- NAVIGATION -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center gap-3" href="../index.html">
                <img width="70" src="../img/logo.png" alt="">
                <span class="nav-link active fs-3 font-protest" aria-current="page">Ricettario
                    Universitario</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
                <div class="navbar-nav d-flex justify-content-center align-items-center gap-2 gap-lg-0">
                    <form class="d-flex w-75" role="search" action="risultati.html">
                        <input type="text" class="form-control" id="search" name="search"
                            placeholder="Cerca una Ricetta">
                        <button class="btn btn-dark ms-1" type="submit">
                            <i class="fa fa-search" aria-hidden="true"></i>
                        </button>
                    </form>
                    <button id="login-trigger" class="btn btn-dark ms-3" type="submit" data-bs-toggle="modal"
                        data-bs-target="#loginModal">Login</button>
                    <button id="logout-trigger" class="btn btn-dark ms-3 d-none" style="width: fit-content"
                        onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- SOTTOMENU -->
    <div class="container-fluid my-1">
        <ul class="nav justify-content-center gap-3 fs-5">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Categorie
                </a>
                <ul id="category-list" class="dropdown-menu">
                    <li class="category-item d-none">
                        <a class="category-item_link dropdown-item" href="#">
                            Categoria Fittizia
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Aree
                </a>
                <ul id="area-list" class="dropdown-menu overflow-y-scroll" style="max-height: 200px;">
                    <li class="area-item d-none">
                        <a class="area-item_link dropdown-item" href="#">
                            Area Fittizia
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item">
                <a id="ricette-salvate" class="nav-link disabled" href="ricettario.html"
                    aria-disabled="true">Ricette Salvate</a>
            </li>
        </ul>
    </div>
    <hr class="mt-0">

    <!-- RICETTA-->
    <div class="container my-5">
        <div class="d-flex align-items-center justify-content-between">
            <h1 id="ricetta_nome" class="font-protest">TITOLO DELLA RICETTA</h1>
            <div class="d-flex">
                <div data-bs-target="#reviewModal" data-bs-toggle="modal">
                    <i class="fa fa-pencil-square-o fs-1 me-2" style="cursor: pointer" aria-hidden="true"
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Lascia la tua recensione"></i>
                </div>
                <div>
                    <i id="salva-ricetta" class="d-none fa fa-heart fs-1 text-secondary" aria-hidden="true"
                        style="cursor: pointer" onclick="toggleSalvaRicetta()" data-bs-toggle="tooltip"
                        data-bs-placement="top" data-bs-title="Salva la ricetta"></i>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <img id="ricetta_img" class="stretched-img w-75"
                src="https://www.themealdb.com/images/media/meals/sutysw1468247559.jpg" alt="">
        </div>
        <div class="m-5">
            <h3 class="text-center">INGREDIENTI</h3>
            <div id="ricetta_ingredienti-container" class="my-5 row justify-content-around">
                <div
                    class="ricetta_ingrediente d-none col-4 d-flex justify-content-start align-items-center gap-3 my-2">
                    <img class="ricetta_ingrediente-img" width="50"
                        src="https://www.themealdb.com/images/ingredients/onions.png" alt="">
                    <p class="ricetta_ingrediente-nome m-0">Ingredient Name</p>
                </div>
            </div>
        </div>
        <div class="m-5">
            <h3 class="text-center">PROCEDIMENTO</h3>
            <div class="mt-4">
                <p id="ricetta_procedimento">Put the onion and oil in a large pan and fry over a fairly high heat for
                    3-4 mins.
                    Add the garlic and mince and fry until they both brown.
                    Add the mushrooms and herbs, and cook for another couple of mins.
                    Stir in the tomatoes, beef stock, tomato ketchup or purée, Worcestershire sauce and seasoning.
                    Bring to the boil, then reduce the heat, cover and simmer, stirring occasionally, for 30 mins.
                    Meanwhile, cook the spaghetti in a large pan of boiling, salted water, according to packet
                    instructions.
                    Drain well, run hot water through it, put it back in the pan and add a dash of olive oil, if you
                    like, then stir in the meat sauce.
                    Serve in hot bowls and hand round Parmesan cheese, for sprinkling on top.</p>
            </div>
        </div>
        <div class="m-5">
            <h3 class="text-center">RECENSIONI</h3>
            <div id="recensioni_container" class="mt-4">
                <div class="card my-2 d-none">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <p class="recensione-data m-0">mm-dd-yyyy</p>
                            <p class="recensione-autore m-0 fw-bold">Nome Cognome</p>
                        </div>
                        <div>
                            <div class="recensione-gusto">
                                <span>Gusto:</span>
                                <i class="fa fa-star" aria-hidden="true"></i>
                                <i class="fa fa-star" aria-hidden="true"></i>
                                <i class="fa fa-star" aria-hidden="true"></i>
                                <i class="fa fa-star" aria-hidden="true"></i>
                                <i class="fa fa-star" aria-hidden="true"></i>
                            </div>
                            <div class="recensione-difficolta">
                                <span>Difficoltà:</span>
                                <i class="fa fa-cutlery" aria-hidden="true"></i>
                                <i class="fa fa-cutlery" aria-hidden="true"></i>
                                <i class="fa fa-cutlery" aria-hidden="true"></i>
                                <i class="fa fa-cutlery" aria-hidden="true"></i>
                                <i class="fa fa-cutlery" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <blockquote class="blockquote mb-0">
                            <p class="recensione-testo">Lorem ipsum dolor sit, amet consectetur adipisicing elit.
                                Debitis expedita tenetur quis
                                suscipit molestiae hic delectus vel repudiandae consequatur asperiores?</p>
                        </blockquote>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- CONSIGLI -->
    <div class="container my-5">
        <h2 class="font-protest">SCELTI PER VOI</h2>
        <!-- 10 PIATTI PER LA STESSA CATEGORIA -->
        <div class="mx-5">
            <h4 class="my-3">Altre Ricette della Categoria "<span id="nome-categoria">NomeCategoria</span>"</h4>
            <div id="category-slider" class="overflow-x-scroll d-flex gap-1">
                <a class="category-card text-decoration-none d-none" href="pages/ricetta.html?id=000">
                    <div class="card flex-shrink-0" style="width: 16rem;">
                        <img src="https://www.themealdb.com/images/media/meals/sutysw1468247559.jpg"
                            class="card_img card-img-top" alt="...">
                        <h5 class="card_name card-title text-center my-3">Spaghetti</h5>
                    </div>
                </a>
            </div>
        </div>
        <!-- 10 PIATTI PER LA STESSA AREA -->
        <div class="mx-5">
            <h4 class="my-3">Altre Ricette dell'Area "<span id="nome-area">NomeArea</span>"</h4>
            <div id="area-slider" class="overflow-x-scroll d-flex gap-1">
                <a class="area-card text-decoration-none d-none" href="pages/ricetta.html?id=000">
                    <div class="card flex-shrink-0" style="width: 16rem;">
                        <img src="https://www.themealdb.com/images/media/meals/sutysw1468247559.jpg"
                            class="card_img card-img-top" alt="...">
                        <h5 class="card_name card-title text-center my-3">Spaghetti</h5>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- FOOTER x Modifica Account -->
    <footer id="footer" class="container-fluid my-4 text-center d-none">
        <p>
            Modifica o Elimina il tuo Account a <a class="text-decoration-underline" href="account.html">questo
                link</a>
        </p>
    </footer>

    <!-- Modal LOGIN -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">LOGIN</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- FORM DI LOGIN -->
                    <div class="container-sm mt-4">
                        <a href="pages/registrazione.html">
                            <p>Non hai un account? Clicca qua per registrarti</p>
                        </a>
                        <p id="errore-login" class="text-danger d-none">Credenziali non valide</p>
                        <form name="login" method="GET" onsubmit="return controllaCampiELogin();">
                            <div class="mb-3">
                                <label for="email" class="form-label">Indirizzo Email</label>
                                <input name="email" id="email" class="form-control" type="email" required>
                            </div>
                            <div class="row align-items-end">
                                <div class="col-md-6 col-12 mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input name="password" id="password" class="form-control" type="password"
                                        oninput="controllaLunghezza(event.srcElement,8)" required>
                                </div>
                                <div class="col-md-6 col-12 mb-3">
                                    <button id="tasto" class="btn btn-primary" style="width:170px"
                                        onclick="mostraPassword(document.getElementById('password'),null,getElementById('tasto')); return false;">Mostra
                                        password</button>
                                </div>
                            </div>
                            <button type="reset" class="btn btn-danger">Resetta</button>
                            <button type="submit" class="btn btn-dark">Login</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal REVIEW -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">LASCIA UNA RECENSIONE</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- FORM DI RECENSIONE -->
                    <div class="container-sm mt-1">
                        <form name="recensione" method="GET" onsubmit="event.preventDefault(); return recensisci();">
                            <div class="mb-3">
                                <textarea class="w-100" name="testo" id="testo" rows="5"
                                    style="resize: none"></textarea>
                            </div>
                            <div class="row align-items-end mb-3">
                                <div class="col-6">
                                    <label for="gusto">Gusto:</label>
                                    <input type="range" class="form-range" id="gusto" name="gusto" min="1" max="5"
                                        step="1">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <i class="fa fa-star text-warning" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <i class="fa fa-star text-warning" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <i class="fa fa-star text-warning" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <i class="fa fa-star text-warning" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <i class="fa fa-star text-warning" aria-hidden="true"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label for="gusto">Difficoltà:</label>
                                    <input type="range" class="form-range my-0" id="difficolta" name="difficolta"
                                        min="1" max="5" step="1">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <i class="fa fa-cutlery text-danger" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <i class="fa fa-cutlery text-danger" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <i class="fa fa-cutlery text-danger" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <i class="fa fa-cutlery text-danger" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <i class="fa fa-cutlery text-danger" aria-hidden="true"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3 d-flex justify-content-center">
                                <label for="data">Data di Preparazione:</label>
                                <input class="ms-3" type="date" name="data" id="data" required>
                            </div>
                            <button type="submit" class="btn btn-dark">Salva</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../script.js"></script>
    <script src="../gestione-form.js"></script>
    <script>

        var parametri = new URLSearchParams(window.location.search);
        var id = parametri.get("id");

        getDettagliRicetta(id).then((ricetta) => {
            //Aggiunta Descrizioni Generali
            document.getElementById("ricetta_nome").innerHTML = ricetta.strMeal;
            document.getElementById("ricetta_img").src = ricetta.strMealThumb;
            document.getElementById("ricetta_procedimento").innerHTML = ricetta.strInstructions;

            //Aggiunta Ingredienti
            var ingredienti_container = document.getElementById("ricetta_ingredienti-container");
            var ingrediente_layout = ingredienti_container.firstElementChild;

            for (var i = 1; i <= 20; i++) {

                var ingredient_name = ricetta["strIngredient" + i];
                var ingredient_measure = ricetta["strMeasure" + i];
                if (ingredient_name) {
                    var new_ingrediente = ingrediente_layout.cloneNode(true);
                    new_ingrediente.classList.remove("d-none");
                    new_ingrediente.getElementsByClassName("ricetta_ingrediente-img")[0].src = "https://www.themealdb.com/images/ingredients/" + ingredient_name + "-Small.png";
                    new_ingrediente.getElementsByClassName("ricetta_ingrediente-nome")[0].innerHTML = ingredient_measure + " - " + ingredient_name;
                    ingredienti_container.appendChild(new_ingrediente);
                }
            }

            //Aggiunta dei Consigliati (Area e Categoria)
            var categoria = ricetta.strCategory;
            document.getElementById("nome-categoria").innerHTML = categoria;
            var category_container = document.getElementById("category-slider");
            var category_card_layout = category_container.getElementsByClassName("category-card")[0];

            getRicetteByCategoria(categoria).then((data) => {
                var ricette = data.ricette;

                for (var i = 0; i < Math.min(10, ricette.length); i++) {
                    var new_category_card = category_card_layout.cloneNode(true);
                    new_category_card.classList.remove("d-none");
                    new_category_card.href = "ricetta.html?id=" + ricette[i].idMeal;
                    new_category_card.getElementsByClassName("card_img")[0].src = ricette[i].strMealThumb;
                    new_category_card.getElementsByClassName("card_name")[0].innerHTML = ricette[i].strMeal;
                    category_container.appendChild(new_category_card);
                }
            })

            var area = ricetta.strArea;
            document.getElementById("nome-area").innerHTML = area;
            var area_container = document.getElementById("area-slider");
            var area_card_layout = area_container.getElementsByClassName("area-card")[0];

            getRicetteByArea(area).then((data) => {
                var ricette = data.ricette;

                for (var i = 0; i < Math.min(10, ricette.length); i++) {
                    var new_area_card = category_card_layout.cloneNode(true);
                    new_area_card.classList.remove("d-none");
                    new_area_card.href = "ricetta.html?id=" + ricette[i].idMeal;
                    new_area_card.getElementsByClassName("card_img")[0].src = ricette[i].strMealThumb;
                    new_area_card.getElementsByClassName("card_name")[0].innerHTML = ricette[i].strMeal;
                    area_container.appendChild(new_area_card);
                }
            })
        });

        // CHECK SE LOGGATO
        var utente_loggato = localStorage.getItem("utente_loggato");
        var utente_corrente = getUtenteByEmail(utente_loggato);

        if (utente_loggato) {
            //Un utente è attualmente loggato
            document.getElementById("salva-ricetta").classList.remove("d-none");
            document.getElementById("login-trigger").classList.add("d-none");
            document.getElementById("logout-trigger").classList.remove("d-none");
            document.getElementById("ricette-salvate").classList.remove("disabled");
            document.getElementById("ricette-salvate").classList.add("text-black");
            document.getElementById("footer").classList.remove("d-none");
            var id_corrente_in_ricettario = utente_corrente.ricettario.find((el) => el.id == id);
            var salva_ricetta = document.getElementById("salva-ricetta");
            if (id_corrente_in_ricettario) {
                salva_ricetta.classList.remove("text-secondary");
                salva_ricetta.classList.add("text-danger");
            }

        }


        // Controllo di Recensioni per il Piatto
        var recensioni_container = document.getElementById("recensioni_container");
        var recensione_layout = recensioni_container.firstElementChild;

        var recensioni_string = localStorage.getItem("recensioni");
        var recensioni = JSON.parse(recensioni_string);

        for (var i = 0; i < recensioni.recensioni.length; i++) {
            var recensione = recensioni.recensioni[i];
            if (recensione.idRicetta == id) {
                //La recensione è relativa alla ricetta corrente
                var nuova_recensione = recensione_layout.cloneNode(true);
                nuova_recensione.classList.remove("d-none");

                nuova_recensione.getElementsByClassName("recensione-data")[0].innerHTML = recensione.data;
                nuova_recensione.getElementsByClassName("recensione-autore")[0].innerHTML = recensione.autore;
                nuova_recensione.getElementsByClassName("recensione-testo")[0].innerHTML = recensione.testo;

                var gusto_container = nuova_recensione.getElementsByClassName("recensione-gusto")[0];
                var icone_gusto = gusto_container.getElementsByTagName("i");
                for (var j = 0; j < recensione.gusto; j++) {
                    icone_gusto[j].classList.add("text-warning");
                }

                var difficolta_container = nuova_recensione.getElementsByClassName("recensione-difficolta")[0];
                var icone_difficolta = difficolta_container.getElementsByTagName("i");
                for (var j = 0; j < recensione.difficolta; j++) {
                    icone_difficolta[j].classList.add("text-danger");
                }

                recensioni_container.appendChild(nuova_recensione);
            }
        }


        function toggleSalvaRicetta() {
            var salva_ricetta = document.getElementById("salva-ricetta");

            if (salva_ricetta.classList.contains("text-danger")) {
                //Rimozione Ricetta
                salva_ricetta.classList.add("text-secondary");
                salva_ricetta.classList.remove("text-danger");
                var utente_corrente = getUtenteByEmail(utente_loggato);
                for (var i = 0; i < utente_corrente.ricettario.length; i++) {
                    if (utente_corrente.ricettario[i].id == id) {
                        console.log("Trovato nel ricettario");
                        utente_corrente.ricettario.splice(i, 1);
                    }
                }
                console.log(utente_corrente);
                updateUtente(utente_corrente);

            } else {
                //Aggiunta Ricetta
                salva_ricetta.classList.remove("text-secondary");
                salva_ricetta.classList.add("text-danger");

                var utente_corrente = getUtenteByEmail(utente_loggato);
                utente_corrente.ricettario.push({
                    id: id,
                    commento: '',
                });
                updateUtente(utente_corrente);
            }

        }

        function recensisci() {

            //Registrazione dell'Utente

            var nuova_recensione = {
                autore: utente_corrente.nome + " " + utente_corrente.cognome,
                idRicetta: id,
                testo: document.getElementById('testo').value,
                gusto: document.getElementById('gusto').value,
                difficolta: document.getElementById('difficolta').value,
                data: document.getElementById('data').value,
            }

            var recensioni_string = localStorage.getItem("recensioni");
            var recensioni_correnti;
            if (!recensioni_string) {
                recensioni_correnti = {
                    recensioni: [],
                }
            } else {
                recensioni_correnti = JSON.parse(recensioni_string);
            }

            recensioni_correnti.recensioni.push(nuova_recensione);

            localStorage.setItem("recensioni", JSON.stringify(recensioni_correnti));

            location.reload();
            return false;
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>
    <script>


        // ENABLE TOOLTIPS (BOOTSTRAP)
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    </script>

</body>

</html>